<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="NMS在计算机视觉领域有着非常重要的应用，如视频目标跟踪、数据挖掘、3D重建、目标识别以及纹理分析等......"/>




  <meta name="keywords" content="python,目标检测,算法," />




  <link rel="alternate" href="/atom.xml" title="Sika">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://sikasjc.github.io/2018/06/12/NMS/"/>


<meta name="description" content="NMS在计算机视觉领域有着非常重要的应用，如视频目标跟踪、数据挖掘、3D重建、目标识别以及纹理分析等......">
<meta name="keywords" content="python,目标检测,算法">
<meta property="og:type" content="article">
<meta property="og:title" content="Non-Maximum Suppression（NMS）非最大抑制">
<meta property="og:url" content="http://sikasjc.github.io/2018/06/12/NMS/index.html">
<meta property="og:site_name" content="Sika">
<meta property="og:description" content="NMS在计算机视觉领域有着非常重要的应用，如视频目标跟踪、数据挖掘、3D重建、目标识别以及纹理分析等......">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="https://i.postimg.cc/D0KFGFFM/23942260.png">
<meta property="og:image" content="https://i.postimg.cc/Qt7hVVL7/11605202.png">
<meta property="og:image" content="https://i.postimg.cc/rFMMF8fd/18696447.png">
<meta property="og:image" content="https://i.postimg.cc/Kcnm2KDS/66398683.png">
<meta property="og:updated_time" content="2018-10-26T15:15:25.915Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Non-Maximum Suppression（NMS）非最大抑制">
<meta name="twitter:description" content="NMS在计算机视觉领域有着非常重要的应用，如视频目标跟踪、数据挖掘、3D重建、目标识别以及纹理分析等......">
<meta name="twitter:image" content="https://i.postimg.cc/D0KFGFFM/23942260.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />







<script>
  var CONFIG = {
    search: ,
    searchPath: "/search.xml",
    fancybox: false,
    toc: true,
  }
</script>




  



    <title> Non-Maximum Suppression（NMS）非最大抑制 · Sika </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Sika</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Sika</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Non-Maximum Suppression（NMS）非最大抑制
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018年6月12日
        </span>
      </div>
        
          <div class="post-tags">
            
              <a href="/tags/python/">python</a>
            
              <a href="/tags/目标检测/">目标检测</a>
            
              <a href="/tags/算法/">算法</a>
            
          </div>
        
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#intrduction"><span class="toc-number">1.</span> <span class="toc-text"> Intrduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nms原理"><span class="toc-number">2.</span> <span class="toc-text"> NMS原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#python实现"><span class="toc-number">3.</span> <span class="toc-text"> Python实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#soft-nms"><span class="toc-number">4.</span> <span class="toc-text"> Soft-NMS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#算法"><span class="toc-number">4.1.</span> <span class="toc-text"> 算法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reference"><span class="toc-number">5.</span> <span class="toc-text"> Reference</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <h2 id="intrduction"><a class="markdownIt-Anchor" href="#intrduction"></a> Intrduction</h2>
<p>NMS(Non-Maximum Suppression)，非最大（极大）抑制。</p>
<p>顾名思义，抑制不是最大值的元素，即抑制最大值以外的值，我们也可以理解为局部最大搜索。这里的局部可以代表一个有两个参数的邻域，一个参数为邻域的维度，另一个为邻域的大小。</p>
<p>这里我们讨论用于二维图像中目标检测的NMS算法，选取邻域中分数最高的窗。例如在目标检测中，滑动窗经提取特征，经分类器识别后，每个窗都生成一个目标分数（检测到目标的概率）和对应的Bounding Box（对于滑动窗，Bounding Box的大小即为滑动窗大小）。但是滑动窗搜索方法会导致很多Bounding Box与其他Bounding Box存在包含或者大部分交叉的情况。这时就需要用到NMS来选取那些邻域中分数最高Bounding Box（是目标的概率最大），并且抑制那些分数低的Bounding Box。</p>
<p><img src="https://i.postimg.cc/D0KFGFFM/23942260.png" alt=""></p>
<p>经过NMS后，我们可以看到保留下来了分数最大的框。</p>
<p><img src="https://i.postimg.cc/Qt7hVVL7/11605202.png" alt=""></p>
<h2 id="nms原理"><a class="markdownIt-Anchor" href="#nms原理"></a> NMS原理</h2>
<p>简单来说，如下所示：</p>
<ol>
<li>获得Bounding Box列表 <strong>B</strong> 和其对应的分数 <strong>S</strong></li>
<li>从 <strong>B</strong> 中选择具有最大分数的Bounding Box <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.10903em;">M</span></span></span></span></li>
<li>将 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.10903em;">M</span></span></span></span> 从 <strong>B</strong> 集合中移除并加入最终返回结果 <strong>D</strong> 中</li>
<li>计算其余 Bounding box 与当前最大分数的Bounding box <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.10903em;">M</span></span></span></span> 的IoU，抑制（去除）IoU大于设定阈值的Bounding Box</li>
<li>重复以上过程，直至 <strong>B</strong> 为空，返回 <strong>D</strong></li>
</ol>
<p>常用 IoU 的阈值为 0.3~0.5，关于 IoU 可以参见<a href="https://sikasjc.github.io/2018/06/03/IoU/">我的博客</a>。</p>
<p><strong>例子：</strong></p>
<p>有 A，B，C，D，E，F 6个 Box，假设分数依次从小到大，这样NMS的流程如下：</p>
<ol>
<li>选择分数最大的 Bounding Box F，此时 <strong>D</strong> 中仅有 F</li>
<li>判断 A~E 中哪个Bounding Box 和 F 的 IoU 大于阈值。假设 B 和 D 大于，则移除 B 和 D</li>
<li>从剩下的 A，C，E 开始，选择分数最大的 E 加入 <strong>D</strong> 中，同时判断 A 和 C 分别与 E 的 IoU，大于 IoU 阈值则移除。假设没有大于阈值 IoU 的 Box</li>
<li>从剩下的 A，C 中选择C，加入 <strong>D</strong> 中，判断 A 和 C 的 IoU 是否大于阈值。假设大于，则移除A</li>
<li>因此，返回的 <strong>D</strong> 为 [F, E, C]</li>
</ol>
<h2 id="python实现"><a class="markdownIt-Anchor" href="#python实现"></a> Python实现</h2>
<p>NMS 思想比较简单，算法复杂度为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><msup><mi>N</mi><mn>2</mn></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ，参考代码如下所示[2]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import the necessary packages</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"> </span><br><span class="line"><span class="comment">#  Felzenszwalb et al.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">non_max_suppression_slow</span><span class="params">(boxes, overlapThresh)</span>:</span></span><br><span class="line">	<span class="comment"># if there are no boxes, return an empty list</span></span><br><span class="line">	<span class="keyword">if</span> len(boxes) == <span class="number">0</span>:</span><br><span class="line">		<span class="keyword">return</span> []</span><br><span class="line"> </span><br><span class="line">	<span class="comment"># initialize the list of picked indexes</span></span><br><span class="line">	pick = []</span><br><span class="line"> </span><br><span class="line">	<span class="comment"># grab the coordinates of the bounding boxes</span></span><br><span class="line">	x1 = boxes[:,<span class="number">0</span>]</span><br><span class="line">	y1 = boxes[:,<span class="number">1</span>]</span><br><span class="line">	x2 = boxes[:,<span class="number">2</span>]</span><br><span class="line">	y2 = boxes[:,<span class="number">3</span>]</span><br><span class="line"> </span><br><span class="line">	<span class="comment"># compute the area of the bounding boxes and sort the bounding</span></span><br><span class="line">	<span class="comment"># boxes by the bottom-right y-coordinate of the bounding box</span></span><br><span class="line">	area = (x2 - x1 + <span class="number">1</span>) * (y2 - y1 + <span class="number">1</span>)</span><br><span class="line">	idxs = np.argsort(y2)</span><br><span class="line">	</span><br><span class="line">	<span class="comment"># keep looping while some indexes still remain in the indexes</span></span><br><span class="line">	<span class="comment"># list</span></span><br><span class="line">	<span class="keyword">while</span> len(idxs) &gt; <span class="number">0</span>:</span><br><span class="line">		<span class="comment"># grab the last index in the indexes list, add the index</span></span><br><span class="line">		<span class="comment"># value to the list of picked indexes, then initialize</span></span><br><span class="line">		<span class="comment"># the suppression list (i.e. indexes that will be deleted)</span></span><br><span class="line">		<span class="comment"># using the last index</span></span><br><span class="line">		last = len(idxs) - <span class="number">1</span></span><br><span class="line">		i = idxs[last]</span><br><span class="line">		pick.append(i)</span><br><span class="line">		suppress = [last]</span><br><span class="line">		</span><br><span class="line">		<span class="comment"># loop over all indexes in the indexes list</span></span><br><span class="line">		<span class="keyword">for</span> pos <span class="keyword">in</span> xrange(<span class="number">0</span>, last):</span><br><span class="line">			<span class="comment"># grab the current index</span></span><br><span class="line">			j = idxs[pos]</span><br><span class="line"> </span><br><span class="line">			<span class="comment"># find the largest (x, y) coordinates for the start of</span></span><br><span class="line">			<span class="comment"># the bounding box and the smallest (x, y) coordinates</span></span><br><span class="line">			<span class="comment"># for the end of the bounding box</span></span><br><span class="line">			xx1 = max(x1[i], x1[j])</span><br><span class="line">			yy1 = max(y1[i], y1[j])</span><br><span class="line">			xx2 = min(x2[i], x2[j])</span><br><span class="line">			yy2 = min(y2[i], y2[j])</span><br><span class="line"> </span><br><span class="line">			<span class="comment"># compute the width and height of the bounding box</span></span><br><span class="line">			w = max(<span class="number">0</span>, xx2 - xx1 + <span class="number">1</span>)</span><br><span class="line">			h = max(<span class="number">0</span>, yy2 - yy1 + <span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">			<span class="comment"># compute the ratio of overlap between the computed</span></span><br><span class="line">			<span class="comment"># bounding box and the bounding box in the area list</span></span><br><span class="line">			overlap = float(w * h) / area[j]</span><br><span class="line"> </span><br><span class="line">			<span class="comment"># if there is sufficient overlap, suppress the</span></span><br><span class="line">			<span class="comment"># current bounding box</span></span><br><span class="line">			<span class="keyword">if</span> overlap &gt; overlapThresh:</span><br><span class="line">				suppress.append(pos)</span><br><span class="line"> </span><br><span class="line">		<span class="comment"># delete all indexes from the index list that are in the</span></span><br><span class="line">		<span class="comment"># suppression list</span></span><br><span class="line">		idxs = np.delete(idxs, suppress)</span><br><span class="line"> </span><br><span class="line">	<span class="comment"># return only the bounding boxes that were picked</span></span><br><span class="line">	<span class="keyword">return</span> boxes[pick]</span><br></pre></td></tr></table></figure>
<p>还有一个更加快速的 NMS 算法版本[3]，使用向量化代码（vectorized code）移除了内部的循环，使用<code>np.maximum</code>和<code>np.minimum</code>函数来代替使用内部for循环来遍历每个单独的 Box————这样可以直接找到<code>array</code>中最大值和最小值。注意<code>np.maximum</code>和<code>np.max</code>的区别。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>np.maximum([<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], [<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>])</span><br><span class="line">array([<span class="number">2</span>, <span class="number">5</span>, <span class="number">4</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>np.maximum(np.eye(<span class="number">2</span>), [<span class="number">0.5</span>, <span class="number">2</span>]) <span class="comment"># broadcasting</span></span><br><span class="line">array([[ <span class="number">1.</span> ,  <span class="number">2.</span> ],</span><br><span class="line">       [ <span class="number">0.5</span>,  <span class="number">2.</span> ]])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>np.maximum([np.nan, <span class="number">0</span>, np.nan], [<span class="number">0</span>, np.nan, np.nan])</span><br><span class="line">array([ NaN,  NaN,  NaN])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>np.maximum(np.Inf, <span class="number">1</span>)</span><br><span class="line">inf</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import the necessary packages</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Malisiewicz et al.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">non_max_suppression_fast</span><span class="params">(boxes, overlapThresh)</span>:</span></span><br><span class="line">	<span class="comment"># if there are no boxes, return an empty list</span></span><br><span class="line">	<span class="keyword">if</span> len(boxes) == <span class="number">0</span>:</span><br><span class="line">		<span class="keyword">return</span> []</span><br><span class="line"> </span><br><span class="line">	<span class="comment"># if the bounding boxes integers, convert them to floats --</span></span><br><span class="line">	<span class="comment"># this is important since we'll be doing a bunch of divisions</span></span><br><span class="line">	<span class="keyword">if</span> boxes.dtype.kind == <span class="string">"i"</span>:</span><br><span class="line">		boxes = boxes.astype(<span class="string">"float"</span>)</span><br><span class="line"> </span><br><span class="line">	<span class="comment"># initialize the list of picked indexes	</span></span><br><span class="line">	pick = []</span><br><span class="line"> </span><br><span class="line">	<span class="comment"># grab the coordinates of the bounding boxes</span></span><br><span class="line">	x1 = boxes[:,<span class="number">0</span>]</span><br><span class="line">	y1 = boxes[:,<span class="number">1</span>]</span><br><span class="line">	x2 = boxes[:,<span class="number">2</span>]</span><br><span class="line">	y2 = boxes[:,<span class="number">3</span>]</span><br><span class="line"> </span><br><span class="line">	<span class="comment"># compute the area of the bounding boxes and sort the bounding</span></span><br><span class="line">	<span class="comment"># boxes by the bottom-right y-coordinate of the bounding box</span></span><br><span class="line">	area = (x2 - x1 + <span class="number">1</span>) * (y2 - y1 + <span class="number">1</span>)</span><br><span class="line">	idxs = np.argsort(y2)</span><br><span class="line"> </span><br><span class="line">	<span class="comment"># keep looping while some indexes still remain in the indexes</span></span><br><span class="line">	<span class="comment"># list</span></span><br><span class="line">	<span class="keyword">while</span> len(idxs) &gt; <span class="number">0</span>:</span><br><span class="line">		<span class="comment"># grab the last index in the indexes list and add the</span></span><br><span class="line">		<span class="comment"># index value to the list of picked indexes</span></span><br><span class="line">		last = len(idxs) - <span class="number">1</span></span><br><span class="line">		i = idxs[last]</span><br><span class="line">		pick.append(i)</span><br><span class="line"> </span><br><span class="line">		<span class="comment"># find the largest (x, y) coordinates for the start of</span></span><br><span class="line">		<span class="comment"># the bounding box and the smallest (x, y) coordinates</span></span><br><span class="line">		<span class="comment"># for the end of the bounding box</span></span><br><span class="line">		xx1 = np.maximum(x1[i], x1[idxs[:last]])</span><br><span class="line">		yy1 = np.maximum(y1[i], y1[idxs[:last]])</span><br><span class="line">		xx2 = np.minimum(x2[i], x2[idxs[:last]])</span><br><span class="line">		yy2 = np.minimum(y2[i], y2[idxs[:last]])</span><br><span class="line"> </span><br><span class="line">		<span class="comment"># compute the width and height of the bounding box</span></span><br><span class="line">		w = np.maximum(<span class="number">0</span>, xx2 - xx1 + <span class="number">1</span>)</span><br><span class="line">		h = np.maximum(<span class="number">0</span>, yy2 - yy1 + <span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">		<span class="comment"># compute the ratio of overlap</span></span><br><span class="line">		overlap = (w * h) / area[idxs[:last]]</span><br><span class="line"> </span><br><span class="line">		<span class="comment"># delete all indexes from the index list that have</span></span><br><span class="line">		idxs = np.delete(idxs, np.concatenate(([last],</span><br><span class="line">			np.where(overlap &gt; overlapThresh)[<span class="number">0</span>])))</span><br><span class="line"> </span><br><span class="line">	<span class="comment"># return only the bounding boxes that were picked using the</span></span><br><span class="line">	<span class="comment"># integer data type</span></span><br><span class="line">	<span class="keyword">return</span> boxes[pick].astype(<span class="string">"int"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="soft-nms"><a class="markdownIt-Anchor" href="#soft-nms"></a> Soft-NMS</h2>
<p>paper: <a href="https://arxiv.org/pdf/1704.04503.pdf" target="_blank" rel="noopener"><strong>Soft-NMS – Improving Object Detection With One Line of Code</strong></a></p>
<p>github: <a href="https://github.com/bharatsingh430/soft-nms" target="_blank" rel="noopener"><strong>soft-nms</strong></a></p>
<p><img src="https://i.postimg.cc/rFMMF8fd/18696447.png" alt="soft-nms"></p>
<p>如上图所示，之前的 NMS 会出现问题：</p>
<ul>
<li>IoU 的阈值如何确定</li>
</ul>
<p>对于红色 Box 和绿色 Box 是当前的检测结果，二者的得分分别是0.95和0.80。IoU 的阈值设小了会导致，首先选中得分最高的红色 Box ，然后绿色 Box 就会因为与之重叠面积过大而被删掉。 设大了话（应删除的 Box 未被删除），又会容易增大误检，降低检测的精度。</p>
<ul>
<li>两个目标 IoU 过大</li>
</ul>
<p>因为两个目标的 IoU 过大，即使我们设置一个大的 NMS 的阈值，也可能会导致绿色 Box 被删除。</p>
<p>这时，我们可以想到应该减少目标邻近检测到的 Box 的分数，使得它们的误检率增加的可能性较小，同时在检测的排名列表中又高于明显误检的分数。</p>
<p><strong>解决思路：降低大于 IoU 阈值的 Box 的目标分数，而不是直接删除IoU大于阈值的 Box。</strong></p>
<h3 id="算法"><a class="markdownIt-Anchor" href="#算法"></a> 算法</h3>
<p>论文中伪代码如下：</p>
<p><img src="https://i.postimg.cc/Kcnm2KDS/66398683.png" alt="soft-nms"></p>
<p>如文章题目而言，就是用一行代码来替换掉原来的NMS。<strong>但Soft-nms仍需指定一个置信度阈值，然后最后得分大于该阈值的检测框得以保留</strong>。</p>
<p>在该算法中，基于重叠部分的大小为相邻检测框设置一个衰减函数而非彻底将其分数置为零。</p>
<p><strong>简单来讲，如果一个检测框与 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.10903em;">M</span></span></span></span> 有大部分重叠，它会有很低的分数；而如果检测框与 M​ 只有小部分重叠，那么它的原有检测分数不会受太大影响</strong>。</p>
<p>具体而言：</p>
<p>传统的NMS处理方法可以通过以下的分数重置函数（Rescoring Function）来表达：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>s</mi><mi>i</mi></msub><mo separator="true">,</mo><mspace width="0.277778em"></mspace><mi>i</mi><mi>o</mi><mi>u</mi><mo>(</mo><mi>M</mi><mo separator="true">,</mo><msub><mi>b</mi><mi>i</mi></msub><mo>)</mo><mo>&lt;</mo><msub><mi>N</mi><mi>t</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn><mo separator="true">,</mo><mspace width="0.277778em"></mspace><mi>i</mi><mi>o</mi><mi>u</mi><mo>(</mo><mi>M</mi><mo separator="true">,</mo><msub><mi>b</mi><mi>i</mi></msub><mo>)</mo><mo>≥</mo><msub><mi>N</mi><mi>t</mi></msub></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">s_i = \left\{\begin{matrix}
s_i, \; iou(M,b_i)&lt;  N_t\\ 
0, \; iou(M,b_i)\geq N_t
\end{matrix}\right.
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.45em;"></span><span class="strut bottom" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="base"><span class="mord"><span class="mord mathit">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mspace thickspace"></span><span class="mord mathit">i</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathit">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mclose">)</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span><span style="top:-2.4099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mspace thickspace"></span><span class="mord mathit">i</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathit">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mclose">)</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9500000000000004em;"></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>在这个公式中， NMS 采用了硬阈值来判断相邻检测框是否保留。</p>
<p>通过衰减与检测框M有重叠的相邻检测框的检测分数是对NMS算法的一种有效改进，<strong>越是与 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.10903em;">M</span></span></span></span> 高度重叠的检测框，越有可能出现误检，它们的分数衰减应该更严重。</strong></p>
<p>论文中soft-nms有两种形式，分别为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtable><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi>s</mi><mi>i</mi></msub><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mspace width="0.277778em"></mspace><mi>i</mi><mi>o</mi><mi>u</mi><mo>(</mo><mi>M</mi><mo separator="true">,</mo><msub><mi>b</mi><mi>i</mi></msub><mo>)</mo><mo>&lt;</mo><msub><mi>N</mi><mi>t</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi>s</mi><mi>i</mi></msub><mo>(</mo><mn>1</mn><mo>−</mo><mi>i</mi><mi>o</mi><mi>u</mi><mo>(</mo><mi>M</mi><mo separator="true">,</mo><msub><mi>b</mi><mi>i</mi></msub><mo>)</mo><mo>)</mo><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mspace width="0.277778em"></mspace><mi>i</mi><mi>o</mi><mi>u</mi><mo>(</mo><mi>M</mi><mo separator="true">,</mo><msub><mi>b</mi><mi>i</mi></msub><mo>)</mo><mo>≥</mo><msub><mi>N</mi><mi>t</mi></msub></mrow></mstyle></mtd></mtr></mtable></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">s_i = \left\{\begin{matrix}
\begin{aligned}
&amp; s_i,&amp; \; iou(M,b_i)&lt;  N_t\\ 
&amp; s_i(1-iou(M,b_i)), &amp;\; iou(M,b_i)\geq N_t
\end{aligned}
\end{matrix}\right.
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.7500000000000002em;"></span><span class="strut bottom" style="height:3.00003em;vertical-align:-1.25003em;"></span><span class="base"><span class="mord"><span class="mord mathit">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.75em;"><span class="pstrut" style="height:3.75em;"></span><span class="mord"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.75em;"><span class="pstrut" style="height:2.84em;"></span><span class="mord"></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:2.84em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mord mathit">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mpunct">,</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mord mathit">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mord rule" style="margin-right:0.2222222222222222em;"></span><span class="mord mathit">i</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathit">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mspace thickspace"></span><span class="mord mathit">i</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathit">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mclose">)</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mspace thickspace"></span><span class="mord mathit">i</span><span class="mord mathit">o</span><span class="mord mathit">u</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10903em;">M</span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathit">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mclose">)</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>和</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>s</mi><mi>i</mi></msub><mo>=</mo><msub><mi>s</mi><mi>i</mi></msub><msup><mi>e</mi><mrow><mo>−</mo><mfrac><mrow><mi>i</mi><mi>o</mi><mi>u</mi><mo>(</mo><mi>M</mi><mo separator="true">,</mo><msub><mi>b</mi><mi>i</mi></msub><msup><mo>)</mo><mn>2</mn></msup></mrow><mrow><mi>δ</mi></mrow></mfrac></mrow></msup><mo separator="true">,</mo><mi mathvariant="normal">∀</mi><msub><mi>b</mi><mi>i</mi></msub><mo>∉</mo><mi>D</mi></mrow><annotation encoding="application/x-tex">s_i =s_ie^{-\frac{iou(M,b_i)^2}{\delta}},\forall b_i \notin D
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.32103em;"></span><span class="strut bottom" style="height:1.5154699999999999em;vertical-align:-0.19444em;"></span><span class="base"><span class="mord"><span class="mord mathit">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathit">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord"><span class="mord mathit">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.32103em;"><span style="top:-3.4130000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2971857142857144em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathit mtight" style="margin-right:0.03785em;">δ</span></span></span></span><span style="top:-3.1275em;"><span class="pstrut" style="height:3em;"></span><span class="stretchy mtight" style="height:0.245em;"><svg width="400em" height="0.245em" viewbox="0 0 400000 200" preserveaspectratio="xMinYMin slice"><path d="M0 80H400000 v40H0z M0 80H400000 v40H0z"/></svg></span></span><span style="top:-3.5483000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathit mtight">i</span><span class="mord mathit mtight">o</span><span class="mord mathit mtight">u</span><span class="mopen mtight">(</span><span class="mord mathit mtight" style="margin-right:0.10903em;">M</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathit mtight">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:0em;margin-right:0.1em;"><span class="pstrut" style="height:2.65952em;"></span><span class="mord mathit mtight">i</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.31472em;"></span></span></span></span></span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.04844em;"><span style="top:-3.04844em;margin-right:0.1em;"><span class="pstrut" style="height:2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mord rule" style="margin-right:0.16666666666666666em;"></span><span class="mord">∀</span><span class="mord"><span class="mord mathit">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"></span></span></span></span></span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∉</span><span class="mord rule" style="margin-right:0.2777777777777778em;"></span><span class="mord mathit" style="margin-right:0.02778em;">D</span></span></span></span></span></p>
<p>对于第一种，当相邻检测框与 M 的重叠度超过重叠阈值 N_t 后，检测框的检测分数呈线性衰减。但是，上述分数重置函数并不是一个连续函数，在重叠程度超过重叠阈值 N_t 时，该分数重置函数产生突变，从而可能导致检测结果序列产生大的变动，因此有了第二种形式。</p>
<p><strong>soft-NMS也是一种贪心算法，并不能保证找到全局最优的检测框分数重置</strong>，但其算法复杂度与 NMS 一致，均为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><msup><mi>N</mi><mn>2</mn></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="base"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ，并不会带来额外的训练和计算负担。同时，NMS 可以看做是 soft-NMS 采用不连续二值权重函数的一个特例。</p>
<p>具体的算法分析与代码，请参见作者的<a href="https://arxiv.org/pdf/1704.04503.pdf" target="_blank" rel="noopener">论文</a>与<a href="https://github.com/bharatsingh430/soft-nms" target="_blank" rel="noopener">github</a>。</p>
<p>在R-FCN以及Faster-RCNN模型中的测试阶段运用Soft-NMS,在MS-COCO数据集上<code>mAP@[0.5:0.95]</code>能够获得大约1%的提升。 如果应用到训练阶段的proposal选取过程理论上也能获得提升。</p>
<h2 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h2>
<p>[1] N. Bodla, B. Singh, R. Chellappa, and L. S. Davis, “Soft-NMS – Improving Object Detection With One Line of Code,” <em>arXiv:1704.04503 [cs]</em>, Apr. 2017.</p>
<p>[2]<a href="https://www.pyimagesearch.com/2014/11/17/non-maximum-suppression-object-detection-python" target="_blank" rel="noopener">Non-Maximum Suppression for Object Detection in Python</a></p>
<p>[3]<a href="https://www.pyimagesearch.com/2015/02/16/faster-non-maximum-suppression-python/" target="_blank" rel="noopener">(Faster) Non-Maximum Suppression in Python</a></p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>作者: </span>
      <span>Sikasjc</span>
    </p>
    <p class="copyright-item">
      <span>链接: </span>
      <a href="http://sikasjc.github.io/2018/06/12/NMS/">http://sikasjc.github.io/2018/06/12/NMS/</a>
    </p>
    <p class="copyright-item lincese">
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/python/">python</a>
            
              <a href="/tags/目标检测/">目标检测</a>
            
              <a href="/tags/算法/">算法</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2018/06/15/iterator-generator/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Python HOWTOS学习，函数式编程（一）</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2018/06/03/IoU/">
        <span class="next-text nav-default">IoU（Intersection over Union）</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>

        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:sikasjc@163.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/sikasjc" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2021

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Sikasjc</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
    
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script type="text/javascript">
var valine = new Valine();
    valine.init({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "x8lD1gvsE8QmIPccHVLe6RmR-gzGzoHsz",
        app_key: "Fgn21BcUswUD2zT3xMg4bRmX",
        placeholder: "欢迎评论，给我发邮件看得更快~",
        avatar: 'hide',
        meta: ['nick', 'mail']
    });
</script>

  


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  </body>
</html>
